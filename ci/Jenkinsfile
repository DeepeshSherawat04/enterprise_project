pipeline {
    agent any

    // Make root folder (workspace) visible to Python in ALL stages
    environment {
        PYTHONPATH = "${WORKSPACE}"
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Checking out the repository..."
            }
        }

        stage('Install Dependencies') {
            steps {
                bat """
                cd /d %WORKSPACE%
                pip install -r requirements.txt
                """
            }
        }

        stage('Run Unit Tests (pytest)') {
            steps {
                bat """
                cd /d %WORKSPACE%
                echo Using PYTHONPATH=%PYTHONPATH%
                pytest -q
                """
            }
        }

        stage('Run ETL Pipeline') {
            steps {
                bat """
                cd /d %WORKSPACE%
                echo Running ETL with PYTHONPATH=%PYTHONPATH%
                python -m etl.fetch_data
                python -m etl.validate_data
                python -m etl.load_data
                """
            }
        }

        stage('API Smoke Test') {
            steps {
                // simple placeholder â€“ we can improve later
                bat """
                cd /d %WORKSPACE%
                echo API smoke test placeholder (FastAPI health can be checked here)
                """
            }
        }

        stage('Done') {
            steps {
                echo "FinDataFlow CI pipeline completed."
            }
        }
    }
}
